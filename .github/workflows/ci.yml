name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    env:
      CI: true  # Set CI environment variable for Lua scripts

    steps:
      # 1. Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Display macOS Version (Optional)
      - name: Display macOS Version
        run: sw_vers

      # 3. Verify Homebrew Installation (Optional)
      - name: Verify Homebrew Installation
        run: brew --version

      # 4. Update Homebrew and Install Neovim and Lua
      - name: Update Homebrew and Install Neovim and Lua
        run: |
          brew update
          brew install neovim lua

      # 5. Cache Neovim Plugins (Optional but Recommended)
      - name: Cache Neovim Plugins
        uses: actions/cache@v3
        with:
          path: ~/.local/share/nvim/lazy
          key: ${{ runner.os }}-nvim-lazy-${{ hashFiles('**/init.lua') }}
          restore-keys: |
            ${{ runner.os }}-nvim-lazy-

      # 6. Create Minimal init.lua for CI with Lazy.nvim Bootstrap
      - name: Create Minimal init.lua for CI
        run: |
          mkdir -p ~/.config/nvim
          cat <<EOF > ~/.config/nvim/init.lua
          -- Minimal init.lua for CI with Lazy.nvim bootstrap
          local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
          if not vim.loop.fs_stat(lazypath) then
            vim.fn.system({
              "git",
              "clone",
              "--filter=blob:none",
              "https://github.com/folke/lazy.nvim.git",
              "--branch=stable", -- latest stable release
              lazypath,
            })
          end
          vim.opt.rtp:prepend(lazypath)
          
          -- Verify if Lazy.nvim was cloned correctly
          if not pcall(require, 'lazy') then
            vim.api.nvim_err_writeln("Failed to load Lazy.nvim")
            return
          end
          
          require('lazy').setup({
            { 'b1gum/tungsten' },
            -- Add other plugins here if necessary
          })
          
          -- Optional: Auto-install plugins on first run
          vim.cmd('autocmd User LazyVimDone ++once lua require("lazy").install()')
          EOF

      # 7. Install Plugin Dependencies via Lazy.nvim
      - name: Install Plugin Dependencies
        run: |
          nvim --headless +Lazy\ install +qa
        env:
          XDG_DATA_HOME: ~/.local/share

      # 8. Verify Plugin Installation
      - name: Verify Plugin Installation
        run: |
          if [ ! -d ~/.local/share/nvim/lazy/tungsten ]; then
            echo "Tungsten plugin not installed correctly."
            exit 1
          fi
          echo "Tungsten plugin installed successfully."

      # 9. List Installed Plugins (Debugging Step)
      - name: List Installed Plugins
        run: |
          echo "Listing installed plugins in ~/.local/share/nvim/lazy/"
          ls -la ~/.local/share/nvim/lazy/

      # 10. Check Lazy.nvim Lua Module (Debugging Step)
      - name: Check Lazy.nvim Lua Module
        run: |
          echo "Checking Lazy.nvim Lua module:"
          ls -la ~/.local/share/nvim/lazy/lazy.nvim/lua/lazy/
          if [ -f ~/.local/share/nvim/lazy/lazy.nvim/lua/lazy/init.lua ]; then
            echo "Lazy.nvim Lua module found."
          else
            echo "Lazy.nvim Lua module not found."
            exit 1
          fi

      # 11. Run Tungsten Test Suite
      - name: Run Tungsten Test Suite
        run: |
          nvim --headless -c "TungstenTestSuite all" -c "qa!"
        env:
          XDG_CONFIG_HOME: ~/.config  # Ensure Neovim can find its config

      # 12. Upload Test Logs
      - name: Upload Test Logs
        if: always()  # Ensure this step runs even if previous steps fail
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: logs/test_logs.txt

      # 13. Display Test Logs (Optional)
      - name: Display Test Logs
        if: always()
        run: |
          if [ -f logs/test_logs.txt ]; then
            echo "=== Test Logs ==="
            cat logs/test_logs.txt
            echo "================="
          else
            echo "No test logs found."
          fi

