name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    env:
      CI: true  # Set CI environment variable for Lua scripts

    steps:
      # 1. Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Set up Homebrew (if not already available)
      - name: Set up Homebrew
        uses: Homebrew/actions/setup@v4

      # 3. Install Neovim
      - name: Install Neovim
        run: brew install neovim

      # 4. Install Lua (if needed)
      - name: Install Lua
        run: brew install lua

      # 5. Clone and set up Lazy.nvim
      - name: Install Lazy.nvim
        run: |
          git clone https://github.com/folke/lazy.nvim.git ~/.local/share/nvim/site/pack/lazy/start/lazy.nvim

      # 6. Install Plugin Dependencies via Lazy.nvim
      - name: Install Plugin Dependencies
        run: |
          nvim --headless +LazyInstall +qa
        env:
          XDG_DATA_HOME: ~/.local/share

      # 7. Run Tests
      - name: Run Tungsten Test Suite
        run: |
          nvim --headless -c "TungstenTestSuite all" -c "qa!"
        env:
          XDG_CONFIG_HOME: ~/.config  # Ensure Neovim can find its config

      # 8. Upload Test Logs
      - name: Upload Test Logs
        if: always()  # Ensure this step runs even if previous steps fail
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: logs/test_logs.txt

      # 9. Display Test Logs (Optional)
      - name: Display Test Logs
        if: always()
        run: |
          if [ -f logs/test_logs.txt ]; then
            echo "=== Test Logs ==="
            cat logs/test_logs.txt
            echo "================="
          else
            echo "No test logs found."
          fi

