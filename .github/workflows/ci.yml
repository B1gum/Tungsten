name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Homebrew
      # Homebrew is pre-installed on macOS runners, but ensuring it's up to date
      run: brew update

    - name: Install Lua
      run: brew install lua@5.4

    - name: Install NeoVim
      run: brew install neovim

    - name: Install Packer.nvim
      run: |
        git clone --depth 1 https://github.com/wbthomason/packer.nvim \
          ~/.local/share/nvim/site/pack/packer/start/packer.nvim

    - name: Prepare Log Directory
      run: mkdir -p logs

    - name: Create Temporary init_ci.lua
      run: |
        cat <<EOF > init_ci.lua
        -- Minimal NeoVim configuration for CI

        -- Disable loading of user-specific configurations
        vim.o.nocompatible = true
        vim.cmd('filetype plugin indent on')

        -- Set runtime path to include packer.nvim and tungsten
        vim.cmd('set runtimepath+=' .. vim.fn.stdpath('data') .. '/site/pack/packer/start/packer.nvim')
        vim.cmd('set runtimepath+=' .. vim.fn.stdpath('data') .. '/site/pack/packer/start/tungsten')

        -- Initialize packer.nvim and install plugins
        require('packer').startup(function()
          use 'wbthomason/packer.nvim'  -- Packer can manage itself
          use 'b1gum/tungsten'          -- Your Tungsten plugin
          -- Add any other plugins required for testing
        end)

        -- Wait for packer to install plugins
        vim.cmd('autocmd User PackerComplete quitall')

        -- Optional: Disable swap files for CI
        vim.o.swapfile = false

        -- Optional: Set minimal UI settings
        vim.o.termguicolors = false
        EOF

    - name: Run Tungsten Test Suite
      env:
        CI: true  # Set an environment variable to indicate CI environment
      run: |
        nvim --headless \
             -u init_ci.lua \
             -c ':PackerSync' \
             -c ':TungstenTestSuite all' \
             -c 'qa!'  # Quit NeoVim after running tests

    - name: Upload Test Logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-logs
        path: logs/test_logs.txt

